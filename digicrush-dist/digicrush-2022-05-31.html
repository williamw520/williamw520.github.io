<!DOCTYPE html>



<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Digi Crush</title>

    <style>
     body {
         background: #222;
     }
    </style>

    

    <script>
     let L = console;
     let assert = console.assert;
    </script>

    
    <script>!function(){"use strict";const t=Math,e={len:e=>t.sqrt(e[0]*e[0]+e[1]*e[1]),unit:t=>{let s=e.len(t);return s>1e-6?[t[0]/s,t[1]/s]:[0,0]},normal:t=>{let s=e.len(t);return s>1e-6?[-t[1]/s,t[0]/s]:[0,0]},rad:e=>t.atan2(e[1],e[0]),from_rad:e=>[t.cos(e),t.sin(e)],add:(t,e)=>[t[0]+e[0],t[1]+e[1]],sub:(t,e)=>[t[0]-e[0],t[1]-e[1]],scale:(t,e)=>[t[0]*e,t[1]*e],dot:(t,e)=>t[0]*e[0]+t[1]*e[1],rad_to_deg:e=>180*e/t.PI,deg_to_rad:e=>e*t.PI/180,unit_deg:t=>t%360},s={len:e=>t.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),unit:t=>{let e=s.len(t);return e>1e-6?[t[0]/e,t[1]/e,t[2]/e]:[0,0,0]},normal:t=>{let e=s.len(t);return e>1e-6?[-t[1]/e,t[0]/e,t[2]/e]:[0,0,0]},add:(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],sub:(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]],scale:(t,e)=>[t[0]*e,t[1]*e,t[2]*e],dot:(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],cross:(t,e)=>[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]],addTo:(t,e)=>(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t),setTo:(t,e)=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t),subFrom:(t,e)=>(t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t),scaleTo:(t,e)=>(t[0]*=e,t[1]*=e,t[2]*=e,t)},i={multiply:(t,e)=>{let s=t[0],i=t[1],a=t[2],o=t[3],r=t[4],h=t[5],n=t[6],l=t[7],_=t[8],c=t[9],f=t[10],u=t[11],p=t[12],d=t[13],m=t[14],g=t[15],T=e[0],E=e[1],A=e[2],S=e[3],v=e[4],O=e[5],y=e[6],I=e[7],w=e[8],B=e[9],F=e[10],x=e[11],P=e[12],b=e[13],R=e[14],L=e[15];return[T*s+E*r+A*_+S*p,T*i+E*h+A*c+S*d,T*a+E*n+A*f+S*m,T*o+E*l+A*u+S*g,v*s+O*r+y*_+I*p,v*i+O*h+y*c+I*d,v*a+O*n+y*f+I*m,v*o+O*l+y*u+I*g,w*s+B*r+F*_+x*p,w*i+B*h+F*c+x*d,w*a+B*n+F*f+x*m,w*o+B*l+F*u+x*g,P*s+b*r+R*_+L*p,P*i+b*h+R*c+L*d,P*a+b*n+R*f+L*m,P*o+b*l+R*u+L*g]},inverse4x4:t=>{let e=t[0],s=t[1],i=t[2],a=t[3],o=t[4],r=t[5],h=t[6],n=t[7],l=t[8],_=t[9],c=t[10],f=t[11],u=t[12],p=t[13],d=t[14],m=t[15],g=c*m,T=d*f,E=h*m,A=d*n,S=h*f,v=c*n,O=i*m,y=d*a,I=i*f,w=c*a,B=i*n,F=h*a,x=l*p,P=u*_,b=o*p,R=u*r,L=o*_,M=l*r,C=e*p,k=u*s,N=e*_,D=l*s,U=e*r,W=o*s,G=g*r+A*_+S*p-(T*r+E*_+v*p),H=T*s+O*_+w*p-(g*s+y*_+I*p),X=E*s+y*r+B*p-(A*s+O*r+F*p),Y=v*s+I*r+F*_-(S*s+w*r+B*_),V=1/(e*G+o*H+l*X+u*Y);return[V*G,V*H,V*X,V*Y,V*(T*o+E*l+v*u-(g*o+A*l+S*u)),V*(g*e+y*l+I*u-(T*e+O*l+w*u)),V*(A*e+O*o+F*u-(E*e+y*o+B*u)),V*(S*e+w*o+B*l-(v*e+I*o+F*l)),V*(x*n+R*f+L*m-(P*n+b*f+M*m)),V*(P*a+C*f+D*m-(x*a+k*f+N*m)),V*(b*a+k*n+U*m-(R*a+C*n+W*m)),V*(M*a+N*n+W*f-(L*a+D*n+U*f)),V*(b*c+M*d+P*h-(L*d+x*h+R*c)),V*(N*d+x*i+k*c-(C*c+D*d+P*i)),V*(C*h+W*d+R*i-(U*d+b*i+k*h)),V*(U*c+L*i+D*h-(N*h+W*c+M*i))]}},a=Math.sin,o=Math.cos,r={scale:(t,e,s,a)=>i.multiply(t,r.scale_mat(e,s,a)),translate:(t,e,s,a)=>i.multiply(t,r.trans_mat(e,s,a)),rotatex:(t,e)=>i.multiply(t,r.rot_x_mat(e)),rotatey:(t,e)=>i.multiply(t,r.rot_y_mat(e)),rotatez:(t,e)=>i.multiply(t,r.rot_z_mat(e)),project_mat:(t,e,s)=>[2/t,0,0,0,0,-2/e,0,0,0,0,2/s,0,-1,1,0,1],orthographic_mat:(t,e,s,i,a,o)=>[2/(e-t),0,0,0,0,2/(i-s),0,0,0,0,2/(a-o),0,(t+e)/(t-e),(s+i)/(s-i),(a+o)/(a-o),1],perspective_mat:(t,e,s,i)=>{let a=Math.tan(.5*Math.PI-.5*t);return[a/e,0,0,0,0,a,0,0,0,0,(s+i)/(s-i),-1,0,0,s*i/(s-i)*2,0]},lookat_mat:(t,e,i)=>{let a=s.unit(s.sub(t,e)),o=s.unit(s.cross(i,a)),r=s.unit(s.cross(a,o));return[o[0],o[1],o[2],0,r[0],r[1],r[2],0,a[0],a[1],a[2],0,t[0],t[1],t[2],1]},identity_mat:()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],scale_mat:(t,e,s)=>[t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1],scale_set:(t,e)=>(t[0]=e[0],t[5]=e[1],t[10]=e[2],t),scale_set1:(t,e)=>(t[0]=e,t[5]=e,t[10]=e,t),trans_mat:(t,e,s)=>[1,0,0,0,0,1,0,0,0,0,1,0,t,e,s,1],trans_set:(t,e)=>(t[12]=e[0],t[13]=e[1],t[14]=e[2],t),rot_x_mat:t=>[1,0,0,0,0,o(t),a(t),0,0,-a(t),o(t),0,0,0,0,1],rot_x_set:(t,e)=>(t[5]=o(e),t[6]=a(e),t[9]=-a(e),t[10]=o(e),t),rot_y_mat:t=>[o(t),0,-a(t),0,0,1,0,0,a(t),0,o(t),0,0,0,0,1],rot_y_set:(t,e)=>(t[0]=o(e),t[2]=-a(e),t[8]=a(e),t[10]=o(e),t),rot_z_mat:t=>[o(t),a(t),0,0,-a(t),o(t),0,0,0,0,1,0,0,0,0,1],rot_z_set:(t,e)=>(t[0]=o(e),t[1]=a(e),t[4]=-a(e),t[5]=o(e),t),v4_multiply_m4:(t,e)=>{let s=[0,0,0,0];for(let i=0;i<4;++i)for(let a=0;a<4;++a)s[i]+=t[a]*e[4*a+i];return s}},h={},n=[],l=[];h.gen_rot_mats=()=>{for(let t=0;t<=360;t++)n.push(r.rot_x_mat(e.deg_to_rad(t))),l.push(r.rot_y_mat(e.deg_to_rad(t)))},h.xrot=t=>n[Math.floor(e.unit_deg(t)+360)%360],h.yrot=t=>l[Math.floor(e.unit_deg(t)+360)%360];let _=[];h.gen_facing_view_mats=t=>{_=f(t)},h.facing_view=t=>_[Math.floor(e.unit_deg(t)+360)%360];let c=[];function f(t,s){let a=[],o=[0,0,0],h=[0,1,0];for(let n=0;n<=360;n++){let l=r.rot_y_mat(e.deg_to_rad(n));l=r.translate(l,t[0],t[1],t[2]);let _=[l[12],l[13],l[14]],c=r.lookat_mat(_,o,h),f=i.inverse4x4(c),u=s?i.multiply(s,f):f;a[n]=u}return a}h.gen_view_projection_mats=(t,e)=>{c=f(t,e)},h.view_projection=t=>c[Math.floor(e.unit_deg(t)+360)%360];let u=function(){const t={loadImages:(t,e)=>{let s=t.length,i=t.map(()=>new Image),a=()=>0==--s&&e(i);return i.forEach((e,s)=>(e.src=t[s],e.onload=a)),i},isPowerOf2:t=>0==(t&t-1),ensurePowerOf2:(t,e)=>{let s=e||1;for(;s<t;)s*=2;return s},first:t=>t.length>0?t[0]:null,last:t=>t.length>0?t[t.length-1]:null,rand:(t,e)=>Math.floor(Math.random()*(e-t+1))+t};return t}(),p=function(){const t={};return t.chars="1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ@$* -!.......;.........;....".split(""),t.charIndex=t.chars.reduce((t,e,s)=>(t[e]=s,t),{}),t.charDim=128,t.fontSize=96,t.digitBegin=0,t.digitLimit=5,t.digit0Limit=9,t.alphaBegin=10,t.F_ZERO=9,t.F_ROCK=36,t.F_CASH=37,t.F_WILDCARD=38,t.F_BLANK=39,t.numIndex=e=>0==e?t.F_ZERO:e-1,t.alphaIndex=e=>t.alphaBegin+(e.charCodeAt(0)-65),t.textIndices=e=>e.split("").map(e=>t.charIndex[e]),t.T_FLAG=0,t.T_ROCK=1,t.T_WILDCARD=2,t.T_BOMB3=3,t.T_BOMB4=4,t.T_FORT_O=5,t.T_FORT_I=6,t.T_FORT_I2=7,t.T_WCHAR=8,t.T_CHAR=9,t.T_404=10,t.SCALE=.25,t.BEGIN_X=6.5,t.LOSING_X=-3,t.PLAYING_ANGLE=-15,t.SPACE_BETWEEN=.6,t.WAVE_STRENGTH=.4,t.LIGHT_DIRECTION=s.unit([-2.5,.5,3]),t.POWER_ELEVATION=.5,t.BOMB3_RANGE=2,t.BOMB4_RANGE=4,t.FORT_O_X=-2.05,t.FORT_I_X=-2,t.FORT_O_SCALE=.125,t.FORT_I_SCALE=.1,t.CASH_X=-3.5,t.CASH_SCALE=.5,t.SCORE_X=4,t.SCORE_Y=3.4,t.SCORE_Z=-2.5,t.SCORE_W=.3,t.GOAL_X=2.5,t.LEVEL_X=1,t.LABEL_X=.5,t.POPUP_X=0,t.POPUP_Y=0,t.POPUP_Z=2.6,t.POPUP_W=.075,t.POPUP_N=14,t.makeFg=e=>{switch(e){case t.T_FLAG:return[0,0,1,1];case t.T_ROCK:return[1,1,.5,1];case t.T_BOMB3:case t.T_BOMB4:case t.T_404:return[1,1,1,1];case t.T_WCHAR:return[0,1,0,1];case t.T_CHAR:return[1,1,1,1];default:return[0,0,0,1]}},t.makeBg=e=>{switch(e){case t.T_FLAG:return[.5,1,0,1];case t.T_ROCK:return[.3961,.3255,.3255,1];case t.T_WILDCARD:return[.5,1,0,1];case t.T_BOMB3:return[.8,.8,.8,1];case t.T_BOMB4:case t.T_404:return[.9,.9,.9,1];case t.T_FORT_O:return[.8157,.8196,.8235,1];case t.T_FORT_I:return[.1765,.9765,.9765,1];case t.T_FORT_I2:return[1,1,1,1];case t.T_WCHAR:return[.9765,.6588,.2471,1];case t.T_CHAR:return[0,0,0,1];default:return[.5,1,0,1]}},t}(),d=function(){const t={};let e,s,i=p.fontSize,a=p.charDim,o=p.charDim;return t.setup=(t,r,h)=>{e=document.getElementById(t),a=r||p.charDim,o=h||p.charDim;let n=a,l=o*p.chars.length;e.width=u.ensurePowerOf2(n),e.height=u.ensurePowerOf2(l),s=e.getContext("2d"),s.fillStyle="#808080",s.textAlign="center",s.textBaseline="middle",s.font=i+"px monospace"},t.drawGrid=()=>{s.strokeStyle="#ff0000";for(let t=o;t<e.height;t+=o)s.beginPath(),s.moveTo(0,t),s.lineTo(a,t),s.stroke()},t.drawAt=(t,e)=>{let r=o*(e-1)+i/1.4+2,h=a/2*.98;s.fillText(t,h,r)},t.textureCanvas=()=>e,t.lineWidth=()=>a,t.lineHeight=()=>o,t}(),m=function(){const t={uploadToBuffer:(t,e,s,i)=>{let a=t.createBuffer();return s=s||t.ARRAY_BUFFER,i=i||t.STATIC_DRAW,t.bindBuffer(s,a),t.bufferData(s,e,i),a},assignBufferToAttr:(t,e,s,i,a,o,r,h)=>{t.bindBuffer(t.ARRAY_BUFFER,e),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,i,a||t.FLOAT,o||!1,r||0,h||0)},assignDataToAttr:(t,s,i)=>{t.disableVertexAttribArray(s),t[e[i.length]](s,i)}};let e=[null,"vertexAttrib1fv","vertexAttrib2fv","vertexAttrib3fv","vertexAttrib4fv"];return t.loadShader=(t,e,s)=>{let i=t.createShader(s);return t.shaderSource(i,e),t.compileShader(i),i},t.createProgram=(e,s,i)=>{let a=e.createProgram();return e.attachShader(a,t.loadShader(e,s,e.VERTEX_SHADER)),e.attachShader(a,t.loadShader(e,i,e.FRAGMENT_SHADER)),e.linkProgram(a),a},t.getAttrMap=(t,e)=>{let s=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);return[...Array(s).keys()].map(s=>t.getActiveAttrib(e,s)).map(t=>t.name).reduce((s,i)=>(s[i]=t.getAttribLocation(e,i),s),{})},t.getUniformMap=(t,e)=>{let s=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);return[...Array(s).keys()].map(s=>t.getActiveUniform(e,s)).map(t=>t.name).reduce((s,i)=>(s[function(t){return"[0]"===t.substr(-3)?t.substr(0,t.length-3):t}(i)]=t.getUniformLocation(e,i),s),{})},t}();let g=function(){const t={};let e,s,i,a,o=0,r={},h={};return t.setupShader=t=>{e=m.createProgram(t,"attribute vec3 a_position;attribute vec2 a_texcoord;attribute vec3 a_normal;uniform mat4 u_projection;uniform mat4 u_facing_view;uniform float u_wave_strength;uniform float u_wave_period;uniform int u_model_type;uniform vec3 u_model_pos;uniform float u_model_scale;uniform mat4 u_model_rot;varying vec3 v_pos;varying vec2 v_texcoord;varying vec3 v_normal;varying float v_slope;float PI_2=2.0*3.141592653589;float fixed_portion=0.85;float param_portion=0.15;float strength=fixed_portion+((1.0-u_wave_strength)*param_portion);void main(){float x=a_position.x;float y=a_position.y;float x2=x-0.001;float y2;if(u_model_type==8){float amplitude=1.0-strength;float waveLen=2.0*strength;y+=((amplitude*((x+strength)/waveLen))*sin(PI_2*(x-u_wave_period)));y2=a_position.y+((amplitude*((x2+strength)/waveLen))*sin(PI_2*(x2-u_wave_period)));}else{y2=y;}vec4 position=vec4(a_position.x,y,a_position.z,1);mat4 model=mat4(u_model_scale);(model[3]).xyzw=vec4(u_model_pos,1.0);model=model*u_model_rot;mat4 matrix=(u_projection*u_facing_view)*model;gl_Position=matrix*position;v_pos=position.xyz;v_normal=mat3(matrix)*a_normal;v_texcoord=a_texcoord;v_slope=y-y2;}","precision mediump float;uniform sampler2D u_sampler;uniform int u_model_type_f;uniform float u_item_index;uniform float u_item_count;uniform vec4 u_foreground;uniform vec4 u_background;uniform vec3 u_light_direction;varying vec3 v_pos;varying vec2 v_texcoord;varying vec3 v_normal;varying float v_slope;float BLOCK_R=1.1;float FORT_O_R=1.35;float FORT_I_R=1.08;float BOMB_R1=1.0;float BOMB_R2=0.85;float BOMB_R3=0.85;vec2 ut1=vec2(-1.0,0.0);vec2 ut2=vec2(-0.1,1.0);vec2 ut3=vec2(-0.1,-1.0);vec2 lt1=vec2(1.0,0.0);vec2 lt2=vec2(0.1,1.0);vec2 lt3=vec2(0.1,-1.0);vec2 rtl=vec2(-0.1,-1.0);vec2 rbr=vec2(0.1,1.0);bool inTriangle(vec3 pt,vec2 t1,vec2 t2,vec2 t3){float A=(1.0/2.0)*((((-t2.y*t3.x)+(t1.y*(-t2.x+t3.x)))+(t1.x*(t2.y-t3.y)))+(t2.x*t3.y));float sign=A<0.0?-1.0:1.0;float s=((((t1.y*t3.x)-(t1.x*t3.y))+((t3.y-t1.y)*pt.x))+((t1.x-t3.x)*pt.y))*sign;float t=((((t1.x*t2.y)-(t1.y*t2.x))+((t1.y-t2.y)*pt.x))+((t2.x-t1.x)*pt.y))*sign;return ((s>0.0)&&(t>0.0))&&((s+t)<((2.0*A)*sign));}bool inRect(vec3 pt,vec2 rtl,vec2 rbr){return (((pt.x>=rtl.x)&&(pt.x<=rbr.x))&&(pt.y>=rtl.y))&&(pt.y<=rbr.y);}vec4 colorByShape(){vec4 color=u_background;float distance=sqrt(dot(v_pos,v_pos));if(u_model_type_f==0){if(!((inTriangle(v_pos,ut1,ut2,ut3)||inTriangle(v_pos,lt1,lt2,lt3))||inRect(v_pos,rtl,rbr)))color=vec4(0.0,0.0,0.0,0.0);}else if(u_model_type_f==1){if(distance>BLOCK_R)color=vec4(0.0,0.0,0.0,0.0);}else if(u_model_type_f==3){if((distance>BOMB_R1)||(distance<BOMB_R2))color=vec4(0.0,0.0,0.0,0.0);}else if((u_model_type_f==4)||(u_model_type_f==10)){if((distance>BOMB_R1)||(distance<BOMB_R3))color=vec4(0.0,0.0,0.0,0.0);}else if(u_model_type_f==5){if(distance>FORT_O_R)color=vec4(0.0,0.0,0.0,0.0);}else if((u_model_type_f==6)||(u_model_type_f==7)){if(distance>FORT_I_R)color=vec4(0.0,0.0,0.0,0.0);}return color;}void main(){float item_height=1.0/u_item_count;float item_y_offset=((u_item_count-u_item_index)-1.0)*item_height;float texcoord_y=item_y_offset+(v_texcoord.y*item_height);vec2 item_texcoord=vec2(v_texcoord.x,texcoord_y);vec4 tcolor=texture2D(u_sampler,item_texcoord);vec4 color;vec3 normal=normalize(v_normal);float light=dot(normal,u_light_direction);if(tcolor.a==0.0){color=colorByShape();}else{color=u_foreground;if(v_slope>0.0){color=mix(color,vec4(0.0,0.0,0.0,1.0),v_slope*300.0);}else if(v_slope<0.0){color=mix(color,vec4(1.0),abs(v_slope)*300.0);}}gl_FragColor=color;if(u_model_type_f==7){}else{gl_FragColor.rgb*=light;}}"),r=m.getAttrMap(t,e),h=m.getUniformMap(t,e)},t.useShader=t=>{t.useProgram(e)},t.setupModel=(t,e,h)=>{let[n,l,_]=function(t,e){let s=[],i=[],a=[],o=(e+e)/t,r=1/t,h=e;for(let n=0;n<=t;n++){let t=o*n-e,l=0+r*n;s.push(t,h,0,t,-h,0),i.push(l,1,l,0),a.push(0,0,-1,0,0,-1)}for(let n=t;n>=0;n--){let t=o*n-e,l=0+r*n;s.push(t,h,0,t,-h,0),i.push(l,1,l,0),a.push(0,0,1,0,0,1)}return[new Float32Array(s),new Float32Array(i),new Float32Array(a)]}(e,h);o=n.length/3,s=m.uploadToBuffer(t,n),i=m.uploadToBuffer(t,l),a=m.uploadToBuffer(t,_),m.assignBufferToAttr(t,s,r.a_position,3,t.FLOAT,!1,0,0),m.assignBufferToAttr(t,i,r.a_texcoord,2,t.FLOAT,!1,0,0),m.assignBufferToAttr(t,a,r.a_normal,3,t.FLOAT,!1,0,0)},t.setupUniforms=(t,e,s,i)=>{t.uniform1f(h.u_wave_strength,e),t.uniform3fv(h.u_light_direction,s),t.uniformMatrix4fv(h.u_projection,!1,i)},t.setupTexture=(t,e,s,i)=>{t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1);let a=t.createTexture();t.activeTexture(e),t.bindTexture(t.TEXTURE_2D,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=t.RGBA,r=t.RGBA,n=t.UNSIGNED_BYTE;t.texImage2D(t.TEXTURE_2D,0,o,r,n,s),t.uniform1f(h.u_item_count,i)},t.draw=(t,e,s,i,a,r,n,l,_,c)=>{t.uniform1i(h.u_sampler,0),t.uniform1f(h.u_item_index,e),t.uniform1i(h.u_model_type,s),t.uniform1i(h.u_model_type_f,s),t.uniform3fv(h.u_model_pos,i),t.uniform1f(h.u_model_scale,a),t.uniformMatrix4fv(h.u_model_rot,!1,r),t.uniform4fv(h.u_foreground,n),t.uniform4fv(h.u_background,l),t.uniform1f(h.u_wave_period,c),t.uniformMatrix4fv(h.u_facing_view,!1,_),t.drawArrays(t.TRIANGLE_STRIP,0,o)},t}(),T=function(){const t={};let s;return t.setup=()=>{t.gl=s=document.getElementById("wgl").getContext("webgl");d.setup("tex"),p.chars.forEach((t,e)=>d.drawAt(t,e+1)),g.setupShader(s),g.useShader(s),g.setupModel(s,d.lineWidth()/4,1),g.setupTexture(s,s.TEXTURE0,d.textureCanvas(),p.chars.length);const i=e.deg_to_rad(60),a=s.canvas.clientWidth/s.canvas.clientHeight;let o=r.perspective_mat(i,a,1,20);g.setupUniforms(s,p.WAVE_STRENGTH,p.LIGHT_DIRECTION,o);var n=[0,0,4];h.gen_rot_mats(),h.gen_facing_view_mats(n),h.gen_view_projection_mats(n,o)},t.cameraAngle=0,t.facingView=()=>h.facing_view(Math.floor(t.cameraAngle)),t.start=()=>{s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.CULL_FACE),s.enable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)},t.gl=s,t}();class E{constructor(){this.nodes=[],this.alive=!0}addChild(t){return this.nodes.push(t),t}onStart(){this.nodes.length>0&&this.nodes.forEach(t=>t.onStart())}onStop(){this.nodes.length>0&&this.nodes.forEach(t=>t.onStop())}onUpdate(t,e,s){if(this.nodes.length>0){this.nodes.forEach(s=>s.onUpdate(t,e,this)),this.nodes.reduce((t,e)=>t||!e.alive,!1)&&(this.nodes=this.nodes.filter(t=>t.alive))}}onDraw(){this.nodes.length>0&&this.nodes.forEach(t=>t.onDraw())}}class A extends E{constructor(){super(),this.frameId=null,this.prevTime=0}start(){L.log("start"),super.onStart(),this.prevTime=performance.now(),this._animate(this.prevTime)}stop(){L.log("stop"),super.onStop(),this.frameId&&cancelAnimationFrame(this.frameId),this.frameId=null}get running(){return null!=this.frameId}_animate(t){this.frameId=requestAnimationFrame(t=>this._animate(t));let e=t-this.prevTime;this.prevTime=t,e>0&&(this.onUpdate(t,e,null),this.onDraw())}onUpdate(t,e,s){super.onUpdate(t,e,s)}onDraw(){super.onDraw()}}let S=function(){const t={Timeline:class{constructor(t,e,s,i){this._start=0,this._time=0,this._rangeMS=t,this._isDone=!0,this._ctx=e,this._onStart=s,this._onStep=i}start(t,e){this._start=this._time=t||performance.now(),this._rangeMS=e||this._rangeMS,this._isDone=!1,this._onStart&&this._onStart(this._ctx,this)}step(t){return this.done||(this._time=t,this._onStep&&this._onStep(this._ctx,this)),this.done}doneNow(){this._isDone=!0}get done(){return this.pos>=1}get pos(){return this._elapse/this._rangeMS}get rpos(){return(this._rangeMS-this._elapse)/this._rangeMS}get _elapse(){return this._isDone?this._rangeMS:Math.min(this._time-this._start,this._rangeMS)}get ctx(){return this._ctx}},TimeGroup:class{constructor(t){this._timelines=t||[],this._stage=0}add(t){return this._timelines.push(t),this}start(t){this._stage=0,this.timeline.start(t)}step(t){return this.done||this.timeline.step(t)&&(this._stage++,this.done||this.timeline.start(t)),this.done}stageDoneNow(){this.done||this.timeline.doneNow()}doneNow(){this._timelines.forEach(t=>t.doneNow())}get timeline(){return this._timelines[this._stage]}get ctx(){return this.timeline.ctx}get pos(){return this.timeline.pos}get rpos(){return this.timeline.rpos}get stage(){return this._stage}get done(){return this._stage>=this._timelines.length}},linear:t=>t,easeInQuad:t=>t*t,easeOutQuad:t=>t*(2-t),easeInOutQuad:t=>t<.5?2*t*t:(4-2*t)*t-1,easeInCubic:t=>t*t*t,easeOutCubic:t=>--t*t*t+1,easeInOutCubic:t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1};return t}(),v=function(){const t={S_INIT_WAIT:0,S_LEVEL_WAIT:1,S_PLAYING:2,S_PAUSED:3,S_WON_PENDING:4,S_WON:5,S_WON_WAIT:6,S_LOST:7,S_LOST_WAIT:8};return t.gstate=t.S_INIT_WAIT,t.level=1,t.nextLevel=1,t.hitGoal=0,t.hitCount=0,t.speed=-.01,t.speedBump=0,t.inSeq=0,t.inSeqCh=0,t.inSeqProbability=.2,t.scoreDisplay=0,t.score=0,t.calcSpeed=()=>{t.speed=-(.01+Math.log(t.level)/200)},t.updateSpeedBump=e=>{t.speedBump=-Math.floor(8-Math.min(e,8))/200},t.calcGoal=()=>{t.hitGoal=Math.floor(Math.min(50+15*Math.log(t.level),99))},t}();let O=[0,0,0];class y{constructor(t,e){this.type=t,this.pos=e,this.offset=[0,0,0],this.ch=p.F_BLANK,this.scale=p.SCALE,this.xrot=0,this.yrot=0,this.rotMatrix=null,this.velocity=[0,0,0],this.force=[0,0,0],this.xrotSpeed=0,this.wavePeriod=50*Math.random(),this.rflag=null,this.fuseTarget=null,this.toPowerType=0,this.elevated=!1,this.bg=p.makeBg(this.type),this.fg=p.makeFg(this.type),this.timeline=new S.Timeline(500),this.animateDir=1,this.fstate=1}clone(){let t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t.pos=[...this.pos],t.offset=[...this.offset],t.velocity=[...this.velocity],t.force=[...this.force],t.bg=[...this.bg],t.fg=[...this.fg],t.timeline=new S.Timeline(500),t}setNext(t){this.rflag=t}isActive(){return 1==this.fstate}isHit(){return 4==this.fstate}isBombed(){return 7==this.fstate}isDead(){return 8==this.fstate}isInLine(){return 1==this.fstate||4==this.fstate||6==this.fstate||7==this.fstate}toHit(){this.timeline.start(performance.now(),250),this.xrotSpeed=8,this.fstate=4}toFlying(){this.timeline.start(performance.now(),700),this.velocity[1]=.05,this.velocity[2]=-.05,this.xrotSpeed=24,this.fstate=5}toFlyingRnd(){return this.timeline.start(performance.now(),1e3),this.velocity[0]=u.rand(-50,50)/100*.2,this.velocity[1]=u.rand(-50,50)/100*.2,this.velocity[2]=u.rand(-50,50)/100*.2,this.xrotSpeed=u.rand(0,6),this.scale=p.SCALE/2,this.bg[0]=u.rand(0,255)/255,this.bg[1]=u.rand(0,255)/255,this.bg[2]=u.rand(0,255)/255,this.ch=p.F_BLANK,this.fstate=5,this}toBombed(){this.timeline.start(performance.now(),300),this.fstate=7}toFuse(t,e,s,i){this.timeline.start(performance.now(),200),this.fuseTarget=t,this.toPowerType=e,null!=s&&(this.ch=s),this.elevated=i,this.fstate=6}toDead(){this.fstate=8,v.score++}morphBomb(t){this.fstate=1,this.type=t,this.ch>p.digit0Limit&&(this.ch=u.rand(0,p.digitLimit)),this.offset[0]=0,this.offset[1]=this.elevated?.1:0,this.offset[2]=0,this.bg=p.makeBg(this.type),this.fg=p.makeFg(this.type)}match(t){return this.isActive()&&(this.ch==t||this.type==p.T_WILDCARD)}onUpdate(t,e,i){switch(this.type){case p.T_BOMB3:break;case p.T_BOMB4:case p.T_404:this.bg[0]=(Math.cos(t/100)+1)/2,this.bg[1]=(Math.sin(t/100)+1)/2,this.bg[2]=(Math.sin(t/100)+1)/2}switch(this.fstate){case 1:case 2:this._updatePhysics(e);break;case 3:break;case 4:this.timeline.step(t)?this.toFlying():this.xrotSpeed=8+Math.floor(6*S.easeInQuad(this.timeline.pos)),this._updatePhysics(e);break;case 5:if(this.timeline.step(t)){this.toDead();break}this.scale-=.015*S.easeInCubic(this.timeline.pos),this._updatePhysics(e);break;case 6:if(this.timeline.step(t)){if(!(this.toPowerType>0)){this.toDead();break}this.morphBomb(this.toPowerType)}else s.setTo(this.offset,this.fuseTarget.pos),s.subFrom(this.offset,this.pos),s.scaleTo(this.offset,this.timeline.pos);this._updatePhysics(e);break;case 7:if(this.timeline.step(t)){this.toDead();break}this._updatePhysics(e)}}onDraw(){if(!this.isDead()&&!this.isBombed()){let t=this.rotMatrix?this.rotMatrix:h.xrot(this.xrot);s.setTo(O,this.pos),s.addTo(O,this.offset),g.draw(T.gl,this.ch,this.type,O,this.scale,t,this.fg,this.bg,T.facingView(),this.wavePeriod)}}_updatePhysics(t){this._adjustToNeighbors(),s.addTo(this.pos,this.velocity),this.isInLine()&&(this.pos[0]+=v.speedBump),s.addTo(this.velocity,this.force),this.wavePeriod+=.001*t,this.xrot+=this.xrotSpeed}_adjustToNeighbors(){if(this.isInLine())if(this.rflag){let t=this.rflag.pos[0]-this.pos[0];t<p.SPACE_BETWEEN-.01?(this.velocity[0]=v.speed,this.pos[0]=this.rflag.pos[0]-p.SPACE_BETWEEN+.01):t>p.SPACE_BETWEEN+.01?this.velocity[0]=.1:this.velocity[0]=v.speed}else this.velocity[0]=v.speed}}let I,w,B,F,x=function(){const t={makeFlag:t=>{let e,s=[p.BEGIN_X,0,0];if(t&&s[0]-t.pos[0]<p.SPACE_BETWEEN&&(s[0]=t.pos[0]+p.SPACE_BETWEEN),v.inSeq>0){let t=new y(p.T_FLAG,s);return t.ch=v.inSeqCh,v.inSeq--,t}if(Math.random()<v.inSeqProbability){const t=u.rand(1,100),e=5-Math.floor(Math.log(t));v.inSeq=Math.min(2,e),v.inSeqCh=u.rand(0,p.digitLimit)}let i=Math.random();return i<.8?(e=new y(p.T_FLAG,s),e.ch=u.rand(0,p.digitLimit)):i>=.8&&i<.9?(e=new y(p.T_ROCK,s),e.ch=p.F_ROCK):i>=.9&&i<.96?(e=new y(p.T_BOMB3,s),e.ch=u.rand(0,p.digitLimit),e.morphBomb(p.T_BOMB3)):i>=.96&&i<.99?(e=new y(p.T_BOMB4,s),e.ch=u.rand(0,p.digitLimit),e.morphBomb(p.T_BOMB3)):(e=new y(p.T_404,s),e.ch=u.rand(0,p.digitLimit),e.morphBomb(p.T_BOMB4)),e},makeFort:(t,e,s,i)=>{let a=new y(t,e);return a.fstate=2,a.scale=s,a.rotMatrix=i,a.ch=p.F_BLANK,a},makeChar:(t,e,s,i,a)=>{let o=new y(a?p.T_WCHAR:p.T_CHAR,e);return o.ch=p.charIndex[t],o.fstate=2,o.scale=s,o.rotMatrix=i,o}};return t}(),P=function(){const t={};let e={},s={},i=t=>{if(e[t.keyCode])return s[t.keyCode]=performance.now(),l(t)},a=t=>(delete s[t.keyCode],l(t));t.startup=t=>{t.addEventListener("keydown",i,!1),t.addEventListener("keyup",a,!1)},t.shutdown=()=>{window.removeEventListener("keydown",i),window.removeEventListener("keyup",a)},t.isOn=t=>{let e=s[t];return e&&delete s[t],e};const o=[49,50,51,52,53,54],r=[85,73,79,74,75,76],h=[85,73,79,74,75,76],n=[o,r,h];function l(t){return t&&(t.stopPropagation&&t.stopPropagation(),null!=t.cancelBubble&&(t.cancelBubble=!0),t.preventDefault&&t.preventDefault(),t.returnValue=!1),!1}return t.K_SPACE=32,t.K_PAUSE=80,[].concat(o,r,h,[t.K_PAUSE,t.K_SPACE]).forEach(t=>e[t]=!0),t.digitHit=e=>{n.forEach(s=>{s.forEach((s,i)=>{t.isOn(s)&&e(i)})})},t}();w=.3,I=(t=1,e=.05,s=220,i=0,a=0,o=.1,r=0,h=1,n=0,l=0,_=0,c=0,f=0,u=0,p=0,d=0,m=0,g=1,T=0,E=0)=>{let A,S,v=2*Math.PI,O=n*=500*v/F**2,y=(0<p?1:-1)*v/4,I=s*=(1+2*e*Math.random()-e)*v/F,w=[],x=0,P=0,b=0,R=1,L=0,M=0,C=0;for(l*=500*v/F**3,p*=v/F,_*=v/F,c*=F,f=F*f|0,S=(i=99+F*i)+(T*=F)+(a*=F)+(o*=F)+(m*=F)|0;b<S;w[b++]=C)++M%(100*d|0)||(C=r?1<r?2<r?3<r?Math.sin((x%v)**3):Math.max(Math.min(Math.tan(x),1),-1):1-(2*x/v%2+2)%2:1-4*Math.abs(Math.round(x/v)-x/v):Math.sin(x),C=(f?1-E+E*Math.sin(2*Math.PI*b/f):1)*(0<C?1:-1)*Math.abs(C)**h*t*.3*(b<i?b/i:b<i+T?1-(b-i)/T*(1-g):b<i+T+a?g:b<S-m?(S-b-m)/o*g:0),C=m?C/2+(m>b?0:(b<S-m?1:(S-b)/m)*w[b-m|0]/2):C),A=(s+=n+=l)*Math.sin(P*p-y),x+=A-A*u*(1-1e9*(Math.sin(b)+1)%2),P+=A-A*u*(1-1e9*(Math.sin(b)**2+1)%2),R&&++R>c&&(s+=_,I+=_,R=0),!f||++L%f||(s=I,n=O,R=R||1);return(t=B.createBuffer(1,S,F)).getChannelData(0).set(w),(s=B.createBufferSource()).buffer=t,s.connect(B.destination),s.start(),s},B=new(window.AudioContext||webkitAudioContext),F=44100;var b=I;let R=function(){const t={sprinkle:()=>b(1,.05,539,0,.04,.29,1,1.92,0,0,567,.02,.02,0,0,0,.04,1,0,0),fuse1:()=>b(1,.05,13,.1,.22,.62,1,.47,.5,0,24,0,.02,0,0,.1,.11,.62,.04,0),fuse2:()=>b(1,.05,245,.24,.22,.71,0,1.31,0,0,-29,.03,.03,0,0,0,0,.66,.09,0),fuse3:()=>b(1,.05,727,.28,.12,.61,1,.57,-3.6,-4.8,-291,.07,.13,0,0,0,.17,.97,.05,0),explosion:()=>b(1,.05,333,.01,0,.9,4,1.9,0,0,0,0,0,.5,0,.6,0,1,0,0),explosion2:()=>b(1,.05,501,0,.01,1.91,4,2.41,.1,.8,0,0,0,.6,0,.4,0,.77,.09,0),shot:()=>b(1,.05,418,0,.02,.2,4,1.15,-8.5,0,0,0,0,.7,0,.1,0,1,0,0),rocket:()=>b(1,.05,941,.8,0,.8,4,.74,-222,0,0,0,0,.8,0,1,0,1,0,0),down:()=>b(1,.05,925,.04,.3,.6,1,.3,0,6.27,-184,.09,.17,0,0,0,0,1,0,0),monster:()=>b(1,.05,662,.82,.11,.33,1,0,0,-.2,0,0,0,1.2,0,.26,.01,1,0,0)};return t}();class M extends E{constructor(){super(),this.flags=[],this.activeFlags=[],this.matchedFlg=[],this.matchedSeq=[],this.matchedBomb=[],this.fortO=[],this.fortI=[],this.cash=[],this.score=[],this.goal=[],this.label=[],this.level=[],this.popup=[],this.scoreDelay=new S.Timeline(200),this.wonStages=this._setupWonStages(),this.lostStages=this._setupLostStages(),this.fortAttackStages=[this._setupFortAttackStages(300,800,1700,!0),this._setupFortAttackStages(500,400,1700,!0)],this.fortAttackType=0,this.fortAttacking=!1,this.popupLen=0,this.lastHitType=0,this._initScore(),this._initPopup(),this._makeFortItems(),this._makeCash()}onStart(){P.startup(window),this._startGame()}onStop(){P.shutdown(window)}onUpdate(t,e,s){this._handleInput(),v.gstate!=v.S_PAUSED&&((this._checkHitFlags()||this._checkBombedFlags())&&this._pullback(),this._checkDeadFlags(),this._fixNextPtr(),this._updateByGameState(t,e),v.updateSpeedBump(this.flags.length),super.onUpdate(t,e,s))}onDraw(){super.onDraw(),this.flags.forEach(t=>t.onDraw()),this.fortO.forEach(t=>t.onDraw()),this.fortI.forEach(t=>t.onDraw()),this.cash.forEach(t=>t.onDraw());let t=T.cameraAngle;T.cameraAngle=0,this.popup.forEach(t=>t.onDraw()),this.score.forEach(t=>t.onDraw()),this.goal.forEach(t=>t.onDraw()),this.level.forEach(t=>t.onDraw()),this.label.forEach(t=>t.onDraw()),T.cameraAngle=t}_startGame(){v.gstate=v.S_INIT_WAIT,v.level=1,this._setPopup("SPACE TO START",-.2,0,-.5)}_startLevel(){v.gstate!=v.S_PLAYING&&(v.gstate=v.S_PLAYING,this._showPopup(!1),this._showItems(this.cash,!0),this._showItems(this.fortO,!0),this._showItems(this.fortI,!0),this._resetOffset(this.cash),this._resetOffset(this.fortO),this._resetOffset(this.fortI),this.fortAttacking=!1,this.fortAttackStages.forEach(t=>t.doneNow()),this.scoreDelay.doneNow(),this.wonStages.doneNow(),this.lostStages.doneNow(),this.scoreDelay.start(),v.calcSpeed(),v.calcGoal(),v.hitCount=0,T.cameraAngle=p.PLAYING_ANGLE,this._spawnFlag())}_handleInput(){if(P.isOn(P.K_SPACE))switch(v.gstate){case v.S_LOST_WAIT:v.nextLevel=1,v.score=0,v.scoreDisplay=0,this._showItems(this.cash,!0),this._showItems(this.fortO,!0),this._showItems(this.fortI,!0),this._resetOffset(this.cash),this._resetOffset(this.fortO),this._resetOffset(this.fortI);case v.S_INIT_WAIT:case v.S_WON_WAIT:v.level=v.nextLevel,this._setPopup("LEVEL "+v.level,-.2,0,0),v.gstate=v.S_LEVEL_WAIT;break;case v.S_LEVEL_WAIT:this._startLevel()}P.isOn(P.K_PAUSE)&&(v.gstate==v.S_PLAYING?v.gstate=v.S_PAUSED:v.gstate==v.S_PAUSED&&(v.gstate=v.S_PLAYING)),v.gstate==v.S_PLAYING&&P.digitHit(t=>this._processMatching(t))}_firstFlag(){for(let t=0;t<this.flags.length;t++)if(this.flags[t].isInLine())return this.flags[t];return null}_lastFlag(){for(let t=this.flags.length-1;t>=0;t--)if(this.flags[t].isInLine())return this.flags[t];return null}_filterActive(){return this.activeFlags.length=0,this.flags.forEach(t=>{t.isActive()&&this.activeFlags.push(t)}),this.activeFlags}_matchFlags(t,e){let s=0;this.matchedFlg.length=0,this.matchedSeq.length=0,this.matchedBomb.length=0,t.forEach((i,a)=>{i.match(e)?(this.lastHitType=i.type,i.type==p.T_BOMB3?(this.matchedBomb.push(t.slice(Math.max(0,a-p.BOMB3_RANGE),Math.min(t.length,a+p.BOMB3_RANGE+1))),R.shot()):i.type==p.T_BOMB4?(this.matchedBomb.push(t.slice(Math.max(0,a-p.BOMB4_RANGE),Math.min(t.length,a+p.BOMB4_RANGE+1))),R.explosion()):i.type==p.T_404?(R.rocket(),this._startFortAttack(0)):(s++,this.matchedFlg.push(i),this.matchedSeq.push(s))):s=0})}_determinePowerType(t,e){return 3==t?p.T_BOMB3:4==t?p.T_BOMB4:t>=5?p.T_404:0}_processMatching(t){this._matchFlags(this._filterActive(),t);for(let t=0;t<this.matchedBomb.length;t++){this.matchedBomb[t].forEach(t=>this._startBombed(t))}for(let e=this.matchedSeq.length-1;e>=0;e--){let s=this.matchedSeq[e],i=this._determinePowerType(s,t);if(i){let t=e-s+1,a=this.matchedFlg[t],o=t;for(i==p.T_404?(this.matchedFlg[o++].toFuse(a,i,3,!0),this.matchedFlg[o++].toFuse(a,i,p.F_ZERO,!0),this.matchedFlg[o++].toFuse(a,i,3,!0),R.fuse3()):i==p.T_BOMB4?(this.matchedFlg[o++].toFuse(a,i),R.fuse2()):i==p.T_BOMB3&&(this.matchedFlg[o++].toFuse(a,i),R.fuse1());o<=e;o++)this.matchedFlg[o].toFuse(a,0);v.hitCount+=o-t,e=t}}this.matchedFlg.reduce((t,e)=>e.isActive()?t+1:t,0)>1&&(this.matchedFlg.forEach(t=>{t.isActive()&&(t.toHit(),v.hitCount++)}),R.sprinkle())}_updateByGameState(t,e){switch(v.gstate){case v.S_INIT_WAIT:case v.S_LEVEL_WAIT:this._updateScore(t),this._rotateFortO(t),this.cash.forEach(s=>s.onUpdate(t,e,this)),this.popup.forEach(s=>s.onUpdate(t,e,this));break;case v.S_PLAYING:this._checkSpawn(),this._rotateFortO(t),this._pulseFortI(t),this._checkFortAttack(t),this._updateScore(t),this.flags.forEach(s=>s.onUpdate(t,e,this)),this.fortO.forEach(s=>s.onUpdate(t,e,this)),this.fortI.forEach(s=>s.onUpdate(t,e,this)),this.cash.forEach(s=>s.onUpdate(t,e,this)),this.popup.forEach(s=>s.onUpdate(t,e,this)),this._checkWinning(),this._checkLosing();break;case v.S_PAUSED:this.popup.forEach(s=>s.onUpdate(t,e,this));break;case v.S_WON_PENDING:this._hasPendingAnimation()||(v.gstate=v.S_WON,this.wonStages.start()),this._rotateFortO(t),this._checkFortAttack(t),this.flags.forEach(s=>s.onUpdate(t,e,this)),this.fortO.forEach(s=>s.onUpdate(t,e,this)),this.fortI.forEach(s=>s.onUpdate(t,e,this)),this.cash.forEach(s=>s.onUpdate(t,e,this)),this.popup.forEach(s=>s.onUpdate(t,e,this));break;case v.S_WON:this.wonStages.step(t)&&(v.gstate=v.S_WON_WAIT,T.cameraAngle=0,this.flags.length=0,this._setPopup("LEVEL PASSED!",-.7,0,0),v.nextLevel=v.level+1),this._rotateFortO(t),this._checkFortAttack(t),this.flags.forEach(s=>s.onUpdate(t,e,this)),this.fortO.forEach(s=>s.onUpdate(t,e,this)),this.fortI.forEach(s=>s.onUpdate(t,e,this)),this.cash.forEach(s=>s.onUpdate(t,e,this)),this.popup.forEach(s=>s.onUpdate(t,e,this));break;case v.S_WON_WAIT:this._rotateFortO(t),this._pulseFortI(t),this._updateScore(t),this.fortO.forEach(s=>s.onUpdate(t,e,this)),this.fortI.forEach(s=>s.onUpdate(t,e,this)),this.cash.forEach(s=>s.onUpdate(t,e,this)),this.popup.forEach(s=>s.onUpdate(t,e,this));break;case v.S_LOST:this.lostStages.step(t)&&(v.gstate=v.S_LOST_WAIT,T.cameraAngle=0,this._setPopup("GAME OVER",-.5,0,0),this._showItems(this.cash,!1),this._showItems(this.fortO,!1),this._showItems(this.fortI,!1),this.flags.length=0),this._rotateFortO(t);break;case v.S_LOST_WAIT:this.popup.forEach(s=>s.onUpdate(t,e,this))}}_setupWonStages(){let t=new S.Timeline(500,this,null,(t,e)=>{T.cameraAngle-=1.5}),e=new S.Timeline(3e3,this,(t,e)=>{this.lastHitType!=p.T_404?t._startFortAttack(1):e.doneNow()},(t,e)=>{});return new S.TimeGroup([t,e])}_checkWinning(){v.gstate==v.S_PLAYING&&v.hitCount>=v.hitGoal&&(v.gstate=v.S_WON_PENDING)}_hasPendingAnimation(){let t=!1;return t|=this.fortAttacking,t}_setupLostStages(){let t=new S.Timeline(1500,this,()=>{R.down()},(t,e)=>{T.cameraAngle-=3}),e=new S.Timeline(400,this,()=>{},(t,e)=>{T.cameraAngle-=1,t._collapseFort(e.pos)}),s=new S.Timeline(2e3,this,()=>{R.explosion2()},(t,e)=>{t._blowupFort(e.pos)});return new S.TimeGroup([t,e,s])}_checkLosing(){let t=this._firstFlag();t&&t.pos[0]<p.LOSING_X&&(v.gstate=v.S_LOST,this.lostStages.start())}_checkSpawn(){let t=this._lastFlag();t?t.pos[0]<p.BEGIN_X&&this._spawnFlag():this._spawnFlag()}_spawnFlag(){this.flags.push(x.makeFlag(this._lastFlag()))}_checkHitFlags(){let t=this.flags.reduce((t,e)=>t||e.isHit(),!1),e=this.hadHit&&!t;return this.hadHit=t,e}_checkBombedFlags(){let t=this.flags.reduce((t,e)=>t||e.isBombed(),!1),e=this.hadBombed&&!t;return this.hadBombed=t,e}_checkDeadFlags(){let t=this.flags.reduce((t,e)=>t||e.isDead(),!1);return t&&(this.flags=this.flags.filter(t=>!t.isDead())),t}_pullback(){let t=this._lastFlag();t&&(t.pos[0]+=p.SPACE_BETWEEN)}_fixNextPtr(){for(let t=0;t<this.flags.length;t++){let e=this.flags[t];if(e.setNext(null),e.isInLine())for(t+=1;t<this.flags.length;t++)if(this.flags[t].isInLine()){e.setNext(this.flags[t]),t--;break}}}_makeFortItems(){let t=h.yrot(90),e=16,s=2;for(let i=0;i<e;i++){let a=2*Math.PI*i/e,o=s*Math.cos(a),r=s*Math.sin(a);this.fortO.push(x.makeFort(p.T_FORT_O,[p.FORT_O_X,o,r],p.FORT_O_SCALE,t))}e=8,s=1.1;for(let i=0;i<e;i++){let a=2*Math.PI*i/e,o=s*Math.cos(a),r=s*Math.sin(a);this.fortI.push(x.makeFort(p.T_FORT_I,[p.FORT_I_X,o,r],p.FORT_I_SCALE,t))}}_rotateFortO(t){let e=t/3e5;for(let t=0;t<16;t++){let s=2*Math.PI*(t/16-e),i=2*Math.cos(s),a=2*Math.sin(s);this.fortO[t].pos[1]=i,this.fortO[t].pos[2]=a}}_pulseFortI(t){let e=t/3600;this.fortI.forEach(t=>t.offset[0]=Math.sin(2*Math.PI*e)/16)}_expandFort(t,e,s,i){let a=t.length;t.forEach((t,o)=>{let r=2*Math.PI*o/a,h=e*Math.cos(r),n=e*Math.sin(r);t.offset[1]=s*h,t.offset[2]=s*n,t.scale=i})}_collapseFort(t){this._expandFort(this.fortO,2*S.easeInQuad(t),-1,p.FORT_O_SCALE*(1-t)),this._expandFort(this.fortI,1.1*S.easeInQuad(t),-1,p.FORT_I_SCALE*(1-t))}_blowupFort(t){this._expandFort(this.fortO,7*S.easeOutQuad(t),1,p.FORT_O_SCALE*(.25+t)),this._expandFort(this.fortI,4.5*S.easeOutQuad(t),1,p.FORT_I_SCALE*(.25+t))}_setupFortAttackStages(t,e,s,i){const a=p.BEGIN_X-p.FORT_I_X;let o=new S.Timeline(t,this,(t,e)=>{t.fortI.forEach(t=>t.offset[0]=.2),t.fortI.forEach(t=>t.type=p.T_FORT_I2),t.fortI.forEach(t=>t.bg=p.makeBg(t.type))}),r=new S.Timeline(e,this,null,(t,e)=>{let s=e.pos*a;t.fortI.forEach(t=>t.offset[0]=s);for(let e=0;e<t.flags.length;e++){let i=t.flags[e];if(i.isActive()){if(i.pos[0]+1.5>s)break;t._startBombed(i),R.shot()}}}),h=new S.Timeline(s,this,(t,e)=>{i&&R.explosion2()},(t,e)=>{let s=e.rpos*a;t.fortI.forEach(t=>t.offset[0]=s)});return new S.TimeGroup([o,r,h])}_startFortAttack(t){this.fortAttacking||(this.fortAttacking=!0,this.fortAttackType=t,this.fortAttackStages[this.fortAttackType].start(),this.lastHitType=p.T_404)}_checkFortAttack(t){this.fortAttacking&&this.fortAttackStages[this.fortAttackType].step(t)&&(this.fortAttacking=!1,this.flags.forEach(t=>{t.isActive()&&this._startBombed(t)}),this._resetOffset(this.fortI),this.fortI.forEach(t=>t.type=p.T_FORT_I),this.fortI.forEach(t=>t.bg=p.makeBg(t.type)))}_startBombed(t){t.toBombed(),v.hitCount++;let e=u.rand(3,5);for(;e-- >0;)this.flags.push(t.clone().toFlyingRnd())}_makeCash(){let t=h.yrot(90);this.cash.push(x.makeChar("$",[p.CASH_X,0,0],p.CASH_SCALE,t,!0))}_initScore(){this.score=[...Array(7).keys()].map((t,e)=>x.makeChar("0",[p.SCORE_X+e*(1.4*p.SCORE_W),p.SCORE_Y,p.SCORE_Z],p.SCORE_W)),this.score.forEach(t=>t.bg=[0,0,0,0]),this.score.forEach(t=>t.fg=[.25,1,.25,1]),this.goal=[...Array(2).keys()].map((t,e)=>x.makeChar("0",[p.GOAL_X+e*(1.4*p.SCORE_W),p.SCORE_Y,p.SCORE_Z],p.SCORE_W)),this.goal.forEach(t=>t.bg=[0,0,0,0]),this.goal.forEach(t=>t.fg=[.25,1,.25,1]),this.level=[...Array(2).keys()].map((t,e)=>x.makeChar("0",[p.LEVEL_X+e*(1.4*p.SCORE_W),p.SCORE_Y,p.SCORE_Z],p.SCORE_W)),this.level.forEach(t=>t.bg=[0,0,0,0]),this.level.forEach(t=>t.fg=[.25,1,.25,1]),this.label=[...Array(1).keys()].map((t,e)=>x.makeChar("L",[p.LABEL_X+e*(1.4*p.SCORE_W),p.SCORE_Y,p.SCORE_Z],p.SCORE_W)),this.label.forEach(t=>t.bg=[0,0,0,0]),this.label.forEach(t=>t.fg=[.25,1,.25,1])}_updateScore(t){this.scoreDelay.step(t)?this.scoreDelay.start(t):(v.scoreDisplay<v.score&&(v.scoreDisplay+=1),this._updateNumber(this.score,v.scoreDisplay)),this._updateNumber(this.goal,Math.max(v.hitGoal-v.hitCount,0)),this._updateNumber(this.level,v.level)}_updateNumber(t,e){t.forEach(t=>t.ch=p.numIndex(0));let s=t.length-1;for(;e>0;){const i=e%10;t[s].ch=p.numIndex(i),e=Math.floor(e/10),s>0&&s--}}_initPopup(){this.popup=[...Array(p.POPUP_N).keys()].map((t,e)=>x.makeChar(" ",[p.POPUP_X+e*(2.2*p.POPUP_W),p.POPUP_Y,p.POPUP_Z],p.POPUP_W,null,!0))}_setPopup(t,e,s,i){const a=t.substring(0,this.popup.length);this.popupLen=a.length,a.split("").map((t,e)=>this.popup[e].ch=p.charIndex[t]),this._setOffset(this.popup,e,s,i),this._showPopup(!0)}_showPopup(t){const e=t?this.popupLen:0;this.popup.forEach((t,s)=>{s<e?(t.bg=[1,1,1,1],t.fg=[.5,0,0,1]):(t.bg=[0,0,0,0],t.fg=[0,0,0,0])})}_showItems(t,e){t.forEach(t=>{e?(t.bg=p.makeBg(t.type),t.fg=p.makeFg(t.type)):t.bg=t.fg=[0,0,0,0]})}_setOffset(t,e,s,i){t.forEach(t=>(t.offset[0]=e,t.offset[1]=s,t.offset[2]=i))}_resetOffset(t){this._setOffset(t,0,0,0)}}let C=function(){const t={};return t.setup=()=>{!function(){let t=document.getElementById("wgl"),e=document.getElementById("desc").offsetHeight,s=96*window.innerWidth/100,i=window.innerHeight-2*e;s/2<i?i=s/2:s/2>i&&(s=2*i);t.width=s,t.height=i}()},t}();window.addEventListener("load",(function(t){C.setup(),T.setup();let e=new A,s=new M;e.addChild(s),T.start(),e.start()}))}();</script>

  </head>

  <body>
    <div style="display: flex; justify-content: center; flex-flow: row;">
      <div></div>
      <div style="display: flex; justify-content: center; flex-flow: column; padding: 1rem;">
        <canvas id="wgl" width="1200" height="600" style="border: 1px solid #626262; background: #111;"></canvas>
        <div id="desc" style="color: white; font-size: 14pt;">
          <p>
            Press 1-6 to eliminate the duplicate digits.  Fuse consecutive digits: 3-digit bomb, 4-digit bomb, and the 404 super-bomb.
          </p>
        </div>
      </div>
      <div></div>
    </div>
    <canvas id="tex" width="128" height="8192" style="display: none;"></canvas>
  </body>

</html>
